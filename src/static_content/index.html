{% extends "base.html" %}
{% set currency_symbol = app_settings.currency_symbol or '$' %}
{% set currency_code = app_settings.currency_code or 'MXN' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/menu.css') }}">

<div class="menu-page" data-menu-root>

    <!-- Category Tabs -->
    <div class="category-tabs" id="category-tabs"></div>

    <!-- Smart Search -->
    <div class="smart-search">
        <div class="smart-search__input">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m21 21-4.35-4.35m0-6.3a6.3 6.3 0 1 1-12.6 0 6.3 6.3 0 0 1 12.6 0z" />
            </svg>
            <input type="search" id="menu-search" placeholder="Busca platillos, ingredientes o categor√≠as..."
                autocomplete="off">
        </div>
        <div class="smart-search__suggestions" id="menu-search-suggestions"></div>
    </div>

    <!-- Quick Filters -->
    <div class="menu-filters" id="menu-filters">
        <div class="menu-filters__header">
            <div class="menu-filters__label">Filtrar por:</div>
            <div class="menu-filters__results" id="filters-results-count">Mostrando 0 productos</div>
        </div>
        <div class="menu-filters__buttons">
            <button type="button" class="filter-chip" data-filter="all" data-active="true">
                <span class="filter-chip__icon">üçΩÔ∏è</span>
                <span class="filter-chip__label">Todos</span>
                <span class="filter-chip__count" data-filter-count="all">0</span>
            </button>
            <button type="button" class="filter-chip" data-filter="breakfast">
                <span class="filter-chip__icon">‚òï</span>
                <span class="filter-chip__label">Desayuno</span>
                <span class="filter-chip__count" data-filter-count="breakfast">0</span>
            </button>
            <button type="button" class="filter-chip" data-filter="afternoon">
                <span class="filter-chip__icon">üåÆ</span>
                <span class="filter-chip__label">Comida</span>
                <span class="filter-chip__count" data-filter-count="afternoon">0</span>
            </button>
            <button type="button" class="filter-chip" data-filter="dinner">
                <span class="filter-chip__icon">üåô</span>
                <span class="filter-chip__label">Cena</span>
                <span class="filter-chip__count" data-filter-count="dinner">0</span>
            </button>
            <button type="button" class="filter-chip" data-filter="quick-serve">
                <span class="filter-chip__icon">‚ö°</span>
                <span class="filter-chip__label">Entrega r√°pida</span>
                <span class="filter-chip__count" data-filter-count="quick-serve">0</span>
            </button>
            <button type="button" class="filter-chip" data-filter="promotion">
                <span class="filter-chip__icon">üéâ</span>
                <span class="filter-chip__label">Promoci√≥n</span>
                <span class="filter-chip__count" data-filter-count="promotion">0</span>
            </button>
        </div>
        <div class="menu-filters__controls">
            <div class="filter-control">
                <label for="filters-sort" class="filter-control__label">Ordenar por</label>
                <select id="filters-sort" class="filter-control__input">
                    <option value="recommended">Recomendados</option>
                    <option value="price-asc">Precio: menor a mayor</option>
                    <option value="price-desc">Precio: mayor a menor</option>
                    <option value="name-asc">Nombre: A-Z</option>
                </select>
            </div>
            <div class="filter-control filter-control--range">
                <label class="filter-control__label">Precio</label>
                <div class="filter-control__range">
                    <input type="number" id="filters-price-min" class="filter-control__input" placeholder="M√≠nimo">
                    <span class="filter-control__separator">‚Äì</span>
                    <input type="number" id="filters-price-max" class="filter-control__input" placeholder="M√°ximo">
                </div>
            </div>
            <button type="button" class="filter-clear" id="filters-clear-btn">Limpiar filtros</button>
        </div>
    </div>

    <!-- Menu Container -->
    <div class="container">
        <div class="menu-empty-state" id="menu-empty-state" hidden>
            <div class="menu-empty-state__icon">üîé</div>
            <h3 class="menu-empty-state__title">Sin coincidencias</h3>
            <p class="menu-empty-state__text">Prueba otros filtros o ajusta el rango de precios.</p>
        </div>
        <div id="menu-sections"></div>
    </div>

    <!-- Checkout Section - Modern 2 Column Layout -->
    <section class="checkout-section" id="checkout-section">
        <div class="checkout-shell">
            <div class="checkout-container">

                <!-- LEFT: Form -->
                <div class="checkout-form">
                    <div class="checkout-form__header">
                        <button type="button" class="back-to-menu-btn" data-action="back-to-menu">‚Üê Volver al men√∫</button>
                        <h2 class="checkout-form__title">Finalizar pedido</h2>
                    </div>

                    <form id="checkout-form">
                        <div class="form-group">
                            <label for="customer-name">Nombre <span style="color: #9ca3af;">(opcional)</span></label>
                            <div class="input-with-icon">
                                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <input type="text" id="customer-name" name="name" placeholder="Tu nombre" class="input-with-icon__field">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="customer-email">Email <span style="color: #9ca3af;">(requerido para pago digital)</span></label>
                            <div class="input-with-icon">
                                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <input type="email" id="customer-email" name="email" placeholder="tu@email.com" class="input-with-icon__field">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="customer-phone">Tel√©fono <span style="color: #9ca3af;">(opcional)</span></label>
                            <div class="phone-input-group">
                                <select id="phone-country-code" class="phone-country-select"></select>
                                <input type="tel" id="customer-phone" name="phone" placeholder="N√∫mero de contacto">
                            </div>
                        </div>

                        <!-- Mesa como Badge Informativo -->
                        <div class="mesa-info-card">
                            <div class="mesa-info-card__icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            <div class="mesa-info-card__content">
                                <h4 class="mesa-info-card__title" id="table-label">
                                    Mesa ‚Äî
                                </h4>
                                <p class="mesa-info-card__text" id="table-subtitle">
                                    Asignada autom√°ticamente por c√≥digo QR
                                </p>
                            </div>
                            <input type="hidden" id="table-number" name="table_number">
                        </div>

                        <div class="form-group">
                            <label for="notes">Notas especiales <span style="color: #9ca3af;">(opcional)</span></label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Alergias, preferencias, etc."></textarea>
                        </div>

                        <div class="feedback-message" id="checkout-feedback"></div>
                    </form>
                </div>

                <!-- RIGHT: Summary (sticky on desktop) -->
                <div class="checkout-summary">
                    <h3 class="checkout-summary__title">Resumen del pedido</h3>

                    <div class="checkout-summary__items" id="checkout-summary"></div>

                    <div class="checkout-summary__total">
                        <span class="checkout-summary__total-label">Total</span>
                        <span class="checkout-summary__total-amount" id="checkout-total">{{ currency_symbol }}0.00</span>
                    </div>

                    <button type="submit" form="checkout-form" class="checkout-submit-btn">
                        Confirmar pedido
                    </button>
                </div>

            </div>
        </div>
    </section>

    <!-- Cart Backdrop -->
    <div class="cart-backdrop" id="cart-backdrop"></div>

    <!-- Cart Panel -->
    <div class="cart-panel" id="cart-panel">
        <div class="cart-header">
            <h2>Tu pedido</h2>
            <button class="cart-close" data-action="cart-close">√ó</button>
        </div>
        <div class="cart-items" id="cart-items">
            <div class="empty-state">
                <div class="empty-state__icon">üçîüò¢</div>
                <h3 class="empty-state__title">Tu carrito est√° vac√≠o</h3>
                <p class="empty-state__text">Agrega algunos platillos deliciosos para empezar</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total">{{ currency_symbol }}0.00</span>
            </div>
            <button class="checkout-btn" data-action="proceed-to-checkout">Ir a pagar</button>
        </div>
    </div>

    <!-- Item Customization Modal -->
    <div class="modal-overlay" id="item-modal">
        <div class="modal"
            style="position: relative !important; z-index: 99999 !important; background: white !important; display: block !important; visibility: visible !important; opacity: 1 !important; box-shadow: 0 20px 100px rgba(0,0,0,0.8) !important;">
            <div class="modal-header">
                <h3 id="modal-item-name"></h3>
                <button class="modal-close" data-action="modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <img id="modal-item-image" class="modal-item-image" src="" alt="">
                <p id="modal-item-description" class="modal-item-description"></p>

                <div class="extras-section" id="extras-section" style="display: none;">
                    <h4>Extras disponibles</h4>
                    <div id="extras-list"></div>
                </div>

                <div class="quantity-selector">
                    <span>Cantidad:</span>
                    <div class="quantity-selector-controls">
                        <button type="button" class="quantity-btn" data-action="quantity-decrease">-</button>
                        <span class="cart-item-quantity" id="modal-quantity">1</span>
                        <button type="button" class="quantity-btn" data-action="quantity-increase">+</button>
                    </div>
                </div>

                <button type="button" class="modal-add-to-cart" data-action="add-to-cart">
                    Agregar al carrito: <span id="modal-total-price">{{ currency_symbol }}0.00</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Preference Overlay -->
    <div class="checkout-preference" id="checkout-preference-overlay" aria-hidden="true">
        <div class="checkout-preference__card">
            <button type="button" class="checkout-preference__close" id="checkout-preference-close"
                aria-label="Cerrar formulario">&times;</button>
            <div class="checkout-preference__status">
                <p class="checkout-preference__title">Avisando al mesero‚Ä¶</p>
                <p class="checkout-preference__subtitle">Elige c√≥mo deseas pagar tu cuenta.</p>
            </div>
            <div class="checkout-preference__buttons">
                <button type="button" class="checkout-preference__btn" data-checkout-method="cash">üíµ Pago en
                    efectivo</button>
                <button type="button" class="checkout-preference__btn" data-checkout-method="terminal">üßæ
                    Terminal</button>
                <button type="button" class="checkout-preference__btn checkout-preference__btn--digital"
                    data-checkout-method="digital">üí≥ Pago digital (Stripe)</button>
            </div>
            <p class="checkout-preference__helper">
                Se cerrar√° en <span id="checkout-preference-timer">{{ app_settings.checkout_prompt_duration_seconds or 6
                    }}</span>s ¬∑
                M√©todo por defecto: <span id="checkout-preference-default">Efectivo</span>
            </p>
        </div>
    </div>

    <!-- Business Hours Modal -->
    <div class="modal" id="business-hours-modal">
        <div class="modal__overlay" onclick="closeBusinessHoursModal()"></div>
        <div class="modal__content modal__content--hours">
            <header class="modal__header">
                <h2>üïí Horarios de Atenci√≥n</h2>
                <button type="button" class="modal__close" onclick="closeBusinessHoursModal()">‚úï</button>
            </header>
            <div class="modal__body" id="business-hours-content">
                <div class="hours-loading">
                    <div class="spinner"></div>
                    <p>Cargando horarios...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>
    // Configuration for menu.js
    window.APP_CONFIG = {
        static_base_url: "{{ static_base_url }}",
        restaurant_assets: "{{ restaurant_assets }}",
        currency_code: "{{ currency_code }}",
        currency_symbol: "{{ currency_symbol }}"
    };
</script>

<script>
    // Business Hours Modal
    let businessHoursData = null;

    async function openBusinessHoursModal() {
        const modal = document.getElementById('business-hours-modal');
        const content = document.getElementById('business-hours-content');

        if (!modal) return;

        // Show modal immediately
        modal.classList.add('active');

        // Load hours if not already loaded
        if (!businessHoursData) {
            try {
                const response = await fetch('/api/business-info');
                const data = await response.json();

                if (data.schedule) {
                    businessHoursData = data.schedule;
                    renderBusinessHours(data.schedule, data.current_day_schedule);
                }
            } catch (error) {
                content.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444;">
                    <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">‚ùå Error al cargar horarios</p>
                    <p style="font-size: 0.9rem; color: #64748b;">Intenta nuevamente m√°s tarde</p>
                </div>
            `;
            }
        } else {
            // Use cached data
            renderBusinessHours(businessHoursData);
        }
    }

    function renderBusinessHours(schedule, currentDaySchedule) {
        const content = document.getElementById('business-hours-content');
        if (!content || !schedule) return;

        const dayNames = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        const dayIcons = ['üìÖ', 'üìÖ', 'üìÖ', 'üìÖ', 'üìÖ', 'üìÖ', 'üåü'];

        const today = new Date().getDay();
        const todayIndex = today === 0 ? 6 : today - 1; // Convert Sunday=0 to our 0-6 format

        content.innerHTML = `
        <div class="hours-list">
            ${schedule.map((day, index) => {
            const isToday = index === todayIndex;
            const isOpen = day.is_open;
            const openTime = day.open_time || '--:--';
            const closeTime = day.close_time || '--:--';

            return `
                    <div class="hours-day ${isToday ? 'hours-day--today' : ''} ${!isOpen ? 'hours-day--closed' : ''}">
                        <div class="hours-day__icon">${dayIcons[index]}</div>
                        <div class="hours-day__info">
                            <div class="hours-day__name">
                                ${day.day_name}
                                ${isToday ? '<span class="hours-badge hours-badge--today">Hoy</span>' : ''}
                            </div>
                            <div class="hours-day__time">
                                ${isOpen ? `${openTime} - ${closeTime}` : 'Cerrado'}
                            </div>
                            ${day.notes ? `<div class="hours-day__notes">${day.notes}</div>` : ''}
                        </div>
                        <div class="hours-day__status">
                            ${isOpen ? '<span class="hours-status hours-status--open">Abierto</span>' : '<span class="hours-status hours-status--closed">Cerrado</span>'}
                        </div>
                    </div>
                `;
        }).join('')}
        </div>

        ${currentDaySchedule && currentDaySchedule.is_open ? `
            <div class="hours-current-info">
                <div class="hours-current-info__icon">‚ú®</div>
                <div class="hours-current-info__text">
                    <strong>Estamos abiertos ahora</strong>
                    <p>Hoy cerramos a las ${currentDaySchedule.close_time}</p>
                </div>
            </div>
        ` : currentDaySchedule ? `
            <div class="hours-current-info hours-current-info--closed">
                <div class="hours-current-info__icon">üåô</div>
                <div class="hours-current-info__text">
                    <strong>Actualmente cerrado</strong>
                    <p>Vuelve a visitarnos durante nuestro horario de atenci√≥n</p>
                </div>
            </div>
        ` : ''}
    `;
    }

    function closeBusinessHoursModal() {
        const modal = document.getElementById('business-hours-modal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // Make functions global
    window.openBusinessHoursModal = openBusinessHoursModal;
    window.closeBusinessHoursModal = closeBusinessHoursModal;
</script>

<!-- Checkout Waiting Overlay -->
<div class="checkout-waiting-overlay" id="checkout-waiting-overlay" style="display: none;">
    <div class="checkout-waiting-content">
        <div class="checkout-waiting-icon">
            <div class="waiter-animation">üßë‚Äçüç≥</div>
        </div>
        <h2 class="checkout-waiting-title">¬°Tu cuenta est√° en camino!</h2>
        <p class="checkout-waiting-message">El mesero te atender√° en un momento</p>
        <div class="checkout-waiting-loader">
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
        </div>
        <button class="checkout-waiting-continue" id="checkout-waiting-continue">Continuar</button>
        <p class="checkout-waiting-hint">Presiona ESC para cerrar</p>
    </div>
</div>

<!-- Payment Confirmed Notification -->
<div class="payment-confirmed-notification" id="payment-confirmed-notification" style="display: none;">
    <div class="payment-confirmed-content">
        <div class="payment-confirmed-icon">‚úÖ</div>
        <h3 class="payment-confirmed-title">¬°Pago confirmado!</h3>
        <p class="payment-confirmed-message">Gracias por tu visita</p>
    </div>
</div>

<!-- Table Selection Modal -->
<div id="table-selection-modal" class="checkout-waiting-overlay" style="display: none;">
    <div class="checkout-waiting-content" style="max-width: 400px;">
        <h2 style="margin-bottom: 1rem;">Selecciona tu mesa</h2>
        <p style="margin-bottom: 1.5rem; color: #64748b;">Por favor indica el n√∫mero de tu mesa para continuar</p>
        <select id="manual-table-select"
                style="width: 100%; padding: 0.75rem; font-size: 1.05rem; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; text-align: center; background: #fff;">
            <option value="">Elige tu mesa</option>
        </select>
        <button id="confirm-table-btn" class="btn btn--primary" style="width: 100%; padding: 0.875rem; font-size: 1rem;">
            Confirmar Mesa
        </button>
    </div>
</div>

<script>
    window.DEBUG_AUTO_TABLE = {{ 'true' if debug_auto_table else 'false' }};
</script>
<script>
    window.__PRONTO_TS_MENU__ = true;
    window.__PRONTO_TS_MENU_SHORTCUTS__ = true;

    // Auto-assign table number based on QR code or debug mode
    (function() {
        const tableLabel = document.getElementById('table-label');
        const tableSubtitle = document.getElementById('table-subtitle');
        const urlParams = new URLSearchParams(window.location.search);
        // Support multiple parameter names for QR codes: mesa, table, m, t
        const tableFromQR = urlParams.get('mesa') || urlParams.get('table') || urlParams.get('m') || urlParams.get('t');
        const tableInput = document.getElementById('table-number');
        const modal = document.getElementById('table-selection-modal');
        const manualSelect = document.getElementById('manual-table-select');
        const confirmBtn = document.getElementById('confirm-table-btn');

        const fallbackBuild = (areaCode, tableNumber) => {
            const normalizedArea = (areaCode || '').trim().replace(/[^A-Za-z0-9]/g, '').toUpperCase().slice(0, 3) || 'G';
            const num = Number(tableNumber);
            if (!Number.isInteger(num) || num < 1 || num > 99) return '';
            return `${normalizedArea}-M${String(num).padStart(2, '0')}`;
        };

        const buildCode = (areaCode, tableNumber) => {
            try {
                if (window.ProntoTableCode?.buildTableCode) {
                    return window.ProntoTableCode.buildTableCode(areaCode, tableNumber);
                }
            } catch (error) {
                console.warn('[TABLE] No se pudo construir el c√≥digo de mesa', error);
            }
            return fallbackBuild(areaCode, tableNumber);
        };

        const DUMMY_TABLES = (() => {
            const make = (label, areaCode, number) => {
                const code = buildCode(areaCode, number);
                return { fullName: label, areaCode, tableNumber: number, code };
            };
            const mesas = Array.from({ length: 10 }, (_, i) => make(`Mesa ${i + 1}`, 'I', i + 1));
            const terrazas = Array.from({ length: 8 }, (_, i) => make(`Terraza ${i + 11}`, 'T', i + 11));
            const barras = Array.from({ length: 4 }, (_, i) => make(`Barra ${i + 1}`, 'B', i + 1));
            const vips = Array.from({ length: 3 }, (_, i) => make(`VIP ${i + 1}`, 'V', i + 1));
            return [...mesas, ...terrazas, ...barras, ...vips];
        })();

        function parseIncomingTable(rawValue, preferSavedLabel = '') {
            if (!rawValue) return null;
            const value = String(rawValue).trim();
            if (!value) return null;
            const utils = window.ProntoTableCode;
            const parsedCode = utils?.parseTableCode?.(value);
            if (parsedCode) {
                const friendlyName = preferSavedLabel || `Mesa ${parsedCode.tableNumber}`;
                return { ...parsedCode, fullName: friendlyName };
            }

            const candidate = DUMMY_TABLES.find((table) => table.code.toUpperCase() === value.toUpperCase() || table.fullName.toUpperCase() === value.toUpperCase());
            if (candidate) {
                return {
                    areaCode: candidate.areaCode,
                    tableNumber: candidate.tableNumber,
                    code: candidate.code,
                    fullName: candidate.fullName
                };
            }

            const digitsMatch = value.match(/(\d{1,2})/);
            const tableNumber = digitsMatch ? Number(digitsMatch[1]) : null;
            const areaCode = utils?.deriveAreaCodeFromLabel?.(value, 'G') || 'G';
            const code = tableNumber ? buildCode(areaCode, tableNumber) : '';
            const fullName = preferSavedLabel || value || (tableNumber ? `Mesa ${tableNumber}` : '');
            if (!code) return null;
            return { areaCode, tableNumber: tableNumber as number, code, fullName };
        }

        function formatTableLabel(table) {
            if (!table) return 'Mesa ‚Äî';
            const baseName = table.fullName || (table.tableNumber ? `Mesa ${table.tableNumber}` : '');
            return table.code ? `${baseName} (${table.code})` : baseName || 'Mesa ‚Äî';
        }

        function assignTable(rawTable, source = 'qr') {
            if (!tableInput) return false;
            const savedLabel = sessionStorage.getItem('pronto-table-label') || undefined;
            const tableData = parseIncomingTable(rawTable, savedLabel);
            if (!tableData) return false;

            tableInput.value = tableData.code;
            sessionStorage.setItem('pronto-table-number', tableData.code);
            sessionStorage.setItem('pronto-table-label', tableData.fullName);

            if (tableLabel) {
                tableLabel.textContent = formatTableLabel(tableData);
            }
            if (tableSubtitle) {
                tableSubtitle.textContent =
                    source === 'qr' ? 'Asignada autom√°ticamente por c√≥digo QR' : 'Seleccionada manualmente';
            }
            return true;
        }

        function renderTableOptions() {
            if (!manualSelect) return;
            const createGroup = (label, values) => {
                const group = document.createElement('optgroup');
                group.label = label;
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value.code;
                    option.textContent = `${value.fullName} (${value.code})`;
                    group.appendChild(option);
                });
                return group;
            };

            const mesas = DUMMY_TABLES.filter(t => t.fullName.toLowerCase().startsWith('mesa '));
            const terrazas = DUMMY_TABLES.filter(t => t.fullName.toLowerCase().startsWith('terraza '));
            const barras = DUMMY_TABLES.filter(t => t.fullName.toLowerCase().startsWith('barra '));
            const vips = DUMMY_TABLES.filter(t => t.fullName.toLowerCase().startsWith('vip '));

            manualSelect.innerHTML = '<option value="">Elige tu mesa</option>';
            manualSelect.appendChild(createGroup('Mesas', mesas));
            manualSelect.appendChild(createGroup('Terraza', terrazas));
            manualSelect.appendChild(createGroup('Barra', barras));
            manualSelect.appendChild(createGroup('VIP', vips));
        }

        function showTableSelectionModal() {
            if (modal) {
                renderTableOptions();
                modal.style.display = 'flex';
                if (manualSelect) manualSelect.focus();
            }
        }

        function hideTableSelectionModal() {
            if (modal) modal.style.display = 'none';
        }

        // Handle manual table confirmation
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                const tableNumber = manualSelect?.value?.trim();
                if (!tableNumber) {
                    alert('Selecciona una mesa v√°lida.');
                    return;
                }
                if (assignTable(tableNumber, 'manual')) {
                    hideTableSelectionModal();
                } else {
                    alert('Mesa no encontrada. Usa una mesa existente (Mesa 1-18, Barra 1-4, VIP 1-3).');
                }
            });
        }

        // Main logic
        let assigned = false;
        if (tableFromQR) {
            // Priority 1: QR code always wins
            assigned = assignTable(tableFromQR, 'qr');
            if (!assigned) {
                alert('Mesa del QR no es v√°lida. Selecciona una mesa existente.');
            }
        } else {
            // Check if table was already assigned
            const savedTable = sessionStorage.getItem('pronto-table-number');

            if (savedTable) {
                // Table already assigned, use it
                assigned = assignTable(savedTable, 'session');
            } else if (window.DEBUG_AUTO_TABLE) {
                // Debug mode: auto-assign Mesa 1 (primer dummy)
                console.log('[DEBUG] Auto-assigning Mesa 1 for testing');
                assigned = assignTable('Mesa 1', 'manual');
            }
        }

        if (!assigned) {
            sessionStorage.removeItem('pronto-table-number');
            // Production mode: show manual selection modal
            showTableSelectionModal();
        }
    })();
</script>
<script type="module" src="{{ url_for('static', filename='js/dist/clients/menu.js') }}"></script>
<script src="{{ url_for('static', filename='js/keyboard-shortcuts.js') }}"></script>
{% endblock %}
